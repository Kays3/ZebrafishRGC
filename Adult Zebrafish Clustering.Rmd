---
title: "Adult Zebrafish Clustering"
output: html_notebook
---

Set directory path and load libraries 
```{r}
# Set directory path
dir_path <- "~/Google Drive File Stream/My Drive/Manuscript - Zebrafish RGC Atlas/Analysis/Analysis2020/"
setwd(dir_path)

# Load libraries
library(Seurat)
library(dplyr)
library(reshape2)
library(ggplot2)
library(cowplot)
source("utils/utilFxns.R")
source("utils/plottingFxns.R")

```


Create the initial Seurat object by loading the Count matrix and set batch information
```{r}
# Load adult zebrafish count matrix
Count.mat <- readRDS("../CountMatrices/ConsolidatedCounts_Zfish_013020.rds")

# Remove sample ZfishRGC16 due to wetting sample failure
cells.remove = grep("ZfishRGC16_",colnames(Count.mat), value=TRUE)
Count.mat = Count.mat[, setdiff(colnames(Count.mat), cells.remove)]

# Create Seurat object, removing genes that are expressed in fewer than 25 cells and removing cells
# that have fewer than 450 features
adult <- CreateSeuratObject(counts = Count.mat, project = "zfishRGC", min.cells = 25, min.features = 450)

# Check QC metrics, including RNA counts and mitochondrial scores
adult[["percent.mt"]] <- PercentageFeatureSet(adult, pattern = "^MT-")
adult[["percent.rps"]] <- PercentageFeatureSet(adult, pattern = "^RPS")
adult[["percent.rpl"]] <- PercentageFeatureSet(adult, pattern = "^RPL")
adult[["percent.rp"]] <- adult[["percent.rps"]] + adult[["percent.rpl"]]
VlnPlot(adult, features = c("nCount_RNA", "percent.mt", "percent.rp"))

# Change the order of factor
adult@meta.data$orig.ident = factor(adult@meta.data$orig.ident, levels = paste0("ZfishRGC",c(1:15)))

# Set batch information in meta.data
batchname = as.character(adult@meta.data$orig.ident)
batchid = rep("Batch0", length(batchname))
batchid[grep("ZfishRGC1$", batchname)] = "Batch1"
batchid[grep("ZfishRGC2", batchname)] = "Batch1"
batchid[grep("ZfishRGC3", batchname)] = "Batch2"
batchid[grep("ZfishRGC4", batchname)] = "Batch2"
batchid[grep("ZfishRGC5", batchname)] = "Batch3"
batchid[grep("ZfishRGC6", batchname)] = "Batch3"
batchid[grep("ZfishRGC7", batchname)] = "Batch3"
batchid[grep("ZfishRGC8", batchname)] = "Batch3"
batchid[grep("ZfishRGC9", batchname)] = "Batch4"
batchid[grep("ZfishRGC10", batchname)] = "Batch4"
batchid[grep("ZfishRGC11", batchname)] = "Batch5"
batchid[grep("ZfishRGC12", batchname)] = "Batch5"
batchid[grep("ZfishRGC13", batchname)] = "Batch5"
batchid[grep("ZfishRGC14", batchname)] = "Batch5"
batchid[grep("ZfishRGC15", batchname)] = "Batch5"
adult@meta.data$batch = factor(batchid)
table(adult@meta.data$orig.ident, adult@meta.data$batch)
```

Cluster the data using functionalities within Seurat.
```{r}
# Log normalize the data, identify the top 2000 variable features, and scale all genes
adult <- NormalizeData(adult, normalization.method = "LogNormalize", scale.factor = 10000)
adult <- FindVariableFeatures(adult, selection.method = "vst", nfeatures = 2000)
all.genes <- rownames(adult)
adult <- ScaleData(adult, features = all.genes)

# Run PCA on variable features and visualize the dimensionality of the dataset using an elbow plot
adult <- RunPCA(adult, features = VariableFeatures(object = adult))
DimPlot(adult, reduction = "pca")
ElbowPlot(adult, ndims = 50)

# Compute clusters using 30 PCs and visualize using UMAP and tSNE
adult <- FindNeighbors(adult, dims = 1:30)
adult <- FindClusters(adult, resolution = .5)

adult <- RunTSNE(adult, dims = 1:30)
adult <- RunUMAP(adult, dims = 1:30)
DimPlot(adult, reduction = "tsne", group.by = "batch")
```

Perform data integration to correct for batch effects. To save memory, this block is not run and the integrated dataset is loaded after.
```{r, warning=FALSE, message=FALSE, eval=FALSE}
# Split object by batch number
adult.list <- SplitObject(adult, split.by = "batch")

# Normalize each dataset and find variable features
for (i in 1:length(adult.list)) {
  adult.list[[i]] <- NormalizeData(adult.list[[i]], verbose = FALSE)
  adult.list[[i]] <- FindVariableFeatures(adult.list[[i]], selection.method = "vst", 
                                             nfeatures = 1500, verbose = FALSE)
}

# Find Integration anchors
adult.anchors <- FindIntegrationAnchors(object.list = adult.list, dims = 1:40)

# Integrate Data and save the object
adult.integrated <- IntegrateData(anchorset = adult.anchors, dims = 1:40)
saveRDS(adult.integrated,"../Objects2020/zFish_SeuratClusteredIntegrated_02042020.rds")
```

```{r, echo=FALSE}
# Load integrated dataset
adult.integrated <- readRDS("../Objects2020/zFish_SeuratClusteredIntegrated_02042020.rds")
```

Run dimensionality reduction and clustering on the integrated data
```{r}
# Switch to integrated assay. The variable features of this assay are automatically
# set during IntegrateData
DefaultAssay(adult.integrated) <- "integrated"
# Run the standard workflow for visualization and clustering
adult.integrated <- ScaleData(adult.integrated, verbose = FALSE)
adult.integrated <- RunPCA(adult.integrated, npcs = 40, verbose = FALSE)
adult.integrated <- RunUMAP(adult.integrated, reduction = "pca", dims = 1:40)
adult.integrated <- RunTSNE(adult.integrated, reduction = "pca", dims = 1:40)
adult.integrated <- FindNeighbors(adult.integrated, dims = 1:40)
adult.integrated <- FindClusters(adult.integrated) #Run Louvain algorithm

# Check out UMAP (integrated vs. non-integrated)
p1 <- DimPlot(adult.integrated, reduction = "umap", group.by = "batch")
p2 <- DimPlot(adult, reduction = "umap", group.by = "batch")
plot_grid(p1, p2, labels = c("Integrated", "Non-integrated"))
```

Investigate cluster markers and remove contaminant cell types
```{r}
# 1 - Low # genes and no distinguishing markers reeeeeeeed
# 3 - Muller Glia (RLBP1A, GLULA, APOEB)
# 9 - Low RBPMS2B and rod markers
# 13 - Glia, endothelial cells (PTGDS, APOEB, ZFP36L1B)
# 18 - Bipolar cells - VSX1, CAPB5A
# 20 - Amacrine cells - GAD1, GAD2, TFAP2A, SLC6A1B, GAD1B
# 22 - Low # genes, nothing distinguishing
# 30 - Abnormally high # genes, and distinguishing markers have a low effect size
# 39 - Glia doublet (RLBP1A, SEPP1A among top markers)
# 41 - Microglia (FCER1GL, CD74A)
# 42 - Endothelial cells (CLDN19, CD82A, CLDNK)
VlnPlot(adult.integrated,"nFeature_RNA", pt.size=0)
VlnPlot(adult.integrated,"rna_RBPMS2B", pt.size=0)
markers1=FindMarkers(adult.integrated, ident.1 = 1, test.use="MAST", max.cells.per.ident = 1000)
markers3=FindMarkers(adult.integrated, ident.1 = 3, test.use="MAST", max.cells.per.ident = 1000)
markers9=FindMarkers(adult.integrated, ident.1 = 9, test.use="MAST", max.cells.per.ident = 1000)
markers13=FindMarkers(adult.integrated, ident.1 = 13, test.use="MAST", max.cells.per.ident = 1000)
markers18=FindMarkers(adult.integrated, ident.1 = 18, test.use="MAST", max.cells.per.ident = 1000)
markers20=FindMarkers(adult.integrated, ident.1 = 20, test.use="MAST", max.cells.per.ident = 1000)
markers22=FindMarkers(adult.integrated, ident.1 = 22, test.use="MAST", max.cells.per.ident = 1000)
markers30=FindMarkers(adult.integrated, ident.1 = 30, test.use="MAST", max.cells.per.ident = 1000)
markers39=FindMarkers(adult.integrated, ident.1 = 39, test.use="MAST", max.cells.per.ident = 1000)
markers41=FindMarkers(adult.integrated, ident.1 = 41, test.use="MAST", max.cells.per.ident = 1000)
markers42=FindMarkers(adult.integrated, ident.1 = 42, test.use="MAST", max.cells.per.ident = 1000)

# Remove contaminant cells from the dataset and subset nonintegrated object
cells.remove = WhichCells(adult.integrated, idents= c(1,3,9, 13, 18, 20, 22, 30, 39, 41, 42))
adult = SubsetData(adult,cells = setdiff(colnames(adult), cells.remove))
```

Since a large number of cells were removed, repeat integration and clustering steps.
```{r, eval = FALSE}
# Split by batch
adult.list <- SplitObject(adult, split.by = "batch")
# Normalize datasets and find variable features
for (i in 1:length(adult.list)) {
  print(i)
  adult.list[[i]] <- NormalizeData(adult.list[[i]], verbose = FALSE)
  adult.list[[i]] <- FindVariableFeatures(adult.list[[i]], selection.method = "vst", 
                                          nfeatures = 2000, verbose = FALSE)
}

# Find Integration anchors and integrate
adult.anchors <- FindIntegrationAnchors(object.list = adult.list, dims = 1:40)
adult.integrated <- IntegrateData(anchorset = adult.anchors, dims = 1:40)
DefaultAssay(adult.integrated) <- "integrated"

# Run the standard workflow for visualization and clustering using the integrated data
adult.integrated <- ScaleData(adult.integrated, verbose = FALSE)
adult.integrated <- RunPCA(adult.integrated, npcs = 40, verbose = FALSE)
adult.integrated <- RunUMAP(adult.integrated, reduction = "pca", dims = 1:40)
adult.integrated <- RunTSNE(adult.integrated, reduction = "pca", dims = 1:40)
adult.integrated <- FindNeighbors(adult.integrated, dims = 1:40)
adult.integrated <- FindClusters(adult.integrated) #Run Louvain algorithm

# Save 
saveRDS(adult.integrated,"../Objects2020/zFish_SeuratClusteredIntegratedWithPruning_02042020.rds")
```

```{r, echo=FALSE}
adult.integrated <- readRDS("../Objects2020/zFish_SeuratClusteredIntegratedWithPruning_02042020.rds")
```

Investigate variable features and remove any remanining contaminants. Set final cluster assignments.
```{r}
# Identify all variable features
adult.markers <- FindAllMarkers(adult.integrated, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
adult.markers %>% group_by(cluster) %>% top_n(n = 5, wt = avg_logFC)

# Remove some remaining contaminant clusters
# Cluster 10, 20, 22 due to lack of unique differentially expressed genes
# Cluster 35: Muller Glia (RLBP1A, APOEB)
VlnPlot(adult.integrated, "GRIA3A", pt.size = 0)
VlnPlot(adult.integrated, "KCNIP3B", pt.size = 0)
head(subset(adult.markers, cluster == 20))
VlnPlot(adult.integrated, "CALB2A", pt.size = 0)
VlnPlot(adult.integrated, "PPP1R1C", pt.size = 0)
head(subset(adult.markers, cluster == 22))
VlnPlot(adult.integrated, "GABRA5", pt.size = 0)
VlnPlot(adult.integrated, "APOEB", pt.size = 0)
VlnPlot(adult.integrated, "RLBP1A", pt.size = 0)

# Remove contaminant cell types
Idents(adult.integrated) <- "integrated_snn_res.0.8"
idents.remove <- c(10, 20, 22, 35)

adult.integrated = subset(adult.integrated, idents = setdiff(levels(Idents(adult.integrated)), idents.remove))

# Refactor final cluster assignments as clusterID
adult.integrated@meta.data$clusterID = droplevels(Idents(adult.integrated))
levels(adult.integrated@meta.data$clusterID) = 1:length(levels(adult.integrated@meta.data$clusterID))
Idents(adult.integrated) <- "clusterID"

```

Construct dendrogram based on hierarchical clustering and reorder clusters
```{r}
# Build dendrogram
adult.integrated <- FindVariableFeatures(adult.integrated, selection.method = "vst", nfeatures = 500)
adult.integrated <- BuildClusterTree(adult.integrated)
PlotClusterTree(adult.integrated)
plot(adult.integrated@tools$BuildClusterTree)

# Reorder clusters according to dendrogram for dotplot plotting
tree_obj = adult.integrated@tools$BuildClusterTree
left_clusts = Seurat:::GetLeftDescendants(tree_obj, length(levels(adult.integrated@meta.data$clusterID))+1)
right_clusts = Seurat:::GetRightDescendants(tree_obj, length(levels(adult.integrated@meta.data$clusterID))+1)
clust_order = c(left_clusts, right_clusts)
adult.integrated@meta.data$dendro_order = factor(adult.integrated@meta.data$clusterID, levels = clust_order)

# Save final adult object
saveRDS(adult.integrated, "../Objects2020/adult_zFish_object.rds")
```

Identify all variable features
```{r}
adult.markers <- FindAllMarkers(adult, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
saveRDS(adult.markers, "../Objects2020/adult_ClusterMarkers")
```


Create plots for figures
```{r, warning=FALSE, message=FALSE}
# Read in object, set order based on dendrogram, and convert genes to lower case
adult <- readRDS("../Objects2020/adult_zFish_object.rds")
Idents(adult) <- "dendro_order"
adult <- LowerCase_genes(adult, integration = TRUE)

# Plot the top 3 DE genes in each cluster
mapGenes_vector <- vector()
for(i in levels(Idents(adult))){
  mapGenes_vector = union(mapGenes_vector, head(subset(adult.markers, cluster==i))[1:3,]$gene)
}
mapGenes_vector <- tolower(mapGenes_vector[2:length(mapGenes_vector)])
DotPlot(adult, features = mapGenes_vector, assay = "RNA") + RotatedAxis()

# Plot canonical RGC markers
DotPlot(adult, features = c("robo2", "isl2b", "rbpms2b"), scale.min = 0, assay = "RNA") + RotatedAxis()

# Visualize clusters on tSNE and UMAP
DimPlot(adult, reduction = "tsne", label = TRUE, group.by = "clusterID")
DimPlot(adult, reduction = "umap", label = TRUE, group.by = "clusterID")

# Plot relative size of each cluster
PlotClusterSize(adult)
```