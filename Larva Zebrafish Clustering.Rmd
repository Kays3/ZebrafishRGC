---
title: "Larva Zebrafish Clustering"
output: html_notebook
---

Set directory path and load libraries 
```{r}
# Set directory path
dir_path <- "~/Google Drive File Stream/My Drive/Manuscript - Zebrafish RGC Atlas/Analysis/Analysis2020/"
setwd(dir_path)

# Load libraries
library(Seurat)
library(dplyr)
library(reshape2)
library(ggplot2)
library(cowplot)
library(cluster, quietly = TRUE)
source("utils/utilFxns.R")
source("utils/plottingFxns.R")

```

Create the initial Seurat object by loading the Count matrix and set batch information
```{r, error=FALSE, message=FALSE}
# Load larval zebrafish count matrix
Count.mat <- readRDS("../CountMatrices/ConsolidatedCounts_LarvaZFish_02032020")

# Remove ZfishRGC17 due to wetting sample failure
cells.remove = grep("ZfishRGC17_",colnames(Count.mat), value=TRUE)
Count.mat = Count.mat[, setdiff(colnames(Count.mat), cells.remove)]

# Create Seurat object
larva <- CreateSeuratObject(counts = Count.mat, project = "larvaRGC", min.cells = 25, min.features = 450)

# Check QC metrics
larva[["percent.mt"]] <- PercentageFeatureSet(larva, pattern = "^MT-")
larva[["percent.rps"]] <- PercentageFeatureSet(larva, pattern = "^RPS")
larva[["percent.rpl"]] <- PercentageFeatureSet(larva, pattern = "^RPL")
larva[["percent.rp"]] <- larva[["percent.rps"]] + larva[["percent.rpl"]]
VlnPlot(larva, features = c("nCount_RNA", "percent.mt", "percent.rp"))

# Change the order of factor
larva@meta.data$orig.ident = factor(larva@meta.data$orig.ident, levels = paste0("ZfishRGC",c(18:20)))

# Set the batch information in meta.data
batchname = as.character(larva@meta.data$orig.ident)
batchid = rep("Batch0", length(batchname))
batchid[grep("ZfishRGC18", batchname)] = "Batch1"
batchid[grep("ZfishRGC19", batchname)] = "Batch2"
batchid[grep("ZfishRGC20", batchname)] = "Batch3"
larva@meta.data$batch = factor(batchid)
table(larva@meta.data$orig.ident, larva@meta.data$batch)
```

Cluster the data using functionalities within Seurat. Check for batch effects.
```{r, warning=FALSE, message=FALSE}
# Log normalize the data, identify the top 2000 variable features, and scale all genes
larva <- NormalizeData(larva, normalization.method = "LogNormalize", scale.factor = 10000)
larva <- FindVariableFeatures(larva, selection.method = "vst", nfeatures = 2000)
all.genes <- rownames(larva)
larva <- ScaleData(larva, features = all.genes)

# Run PCA on variable features and visualize the dimensionality of the dataset using an elbow plot
larva <- RunPCA(larva, features = VariableFeatures(object = larva))
DimPlot(larva, reduction = "pca")
ElbowPlot(larva, ndims = 50)

# Find nearest neighbors using 30 PCs and cluster the cells. Visualize using tSNE and UMAP
larva <- FindNeighbors(larva, dims = 1:30)
larva <- FindClusters(larva, resolution = .5)
larva <- RunTSNE(larva, dims = 1:30)
larva <- RunUMAP(larva, dims = 1:30)
DimPlot(larva, reduction = "tsne")
DimPlot(larva, reduction =  "umap")

# Check for batch effects
DimPlot(larva, reduction = "tsne", group.by = "orig.ident", cells = sample(colnames(larva)))
```

Investigate cluster markers and remove contaminant cell types
```{r, warning=FALSE, message=FALSE}
# Prune some clusters to remove contaminant cell types 
# 17 - Amacrine cell (TFAP2B)
# 21 - Amacrine cell (GAD1B, GAD2, SLC6A1B)
# 22 - Photoreceptor (PDE6G, SAGB)
# 23 - Photoreceptor (PDE6H, ARR3A, RBP4L)
VlnPlot(larva,"nFeature_RNA", pt.size=0)
VlnPlot(larva,"RBPMS2B", pt.size=0)
markers17=FindMarkers(larva, ident.1 = 17, test.use="MAST", max.cells.per.ident = 1000)
markers21=FindMarkers(larva, ident.1 = 21, test.use="MAST", max.cells.per.ident = 1000)
markers22=FindMarkers(larva, ident.1 = 22, test.use="MAST", max.cells.per.ident = 1000)
markers23=FindMarkers(larva, ident.1 = 23, test.use="MAST", max.cells.per.ident = 1000)

# Remove contaminant cell types
cells.remove = WhichCells(larva, idents= c(17, 21, 22, 23))
larva = SubsetData(larva,cells = setdiff(colnames(larva), cells.remove))
```


Since a large number of cells were removed, repeat clustering steps. 
```{r, error=FALSE, message=FALSE}
# Run the standard workflow for visualization and clustering using the integrated data
larva <- NormalizeData(larva, normalization.method = "LogNormalize", scale.factor = 10000)
larva <- FindVariableFeatures(larva, selection.method = "vst", nfeatures = 2000)
larva <- ScaleData(larva, verbose = FALSE)
larva <- RunPCA(larva, npcs = 40, verbose = FALSE)
larva <- RunUMAP(larva, reduction = "pca", dims = 1:40)
larva <- RunTSNE(larva, reduction = "pca", dims = 1:40)
larva <- FindNeighbors(larva, dims = 1:40)
larva <- FindClusters(larva) #Run Louvain algorithm
```

```{r, error=FALSE, message=FALSE}
# Identify all variable features
lar.markers <- FindAllMarkers(larva, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
lar.markers %>% group_by(cluster) %>% top_n(n = 1, wt = avg_logFC)

# Remove remaining any non valid clusters
# Cluster 5: Lacks of unique differentially expressed genes
# Cluster 28: Muller Glia (RLBP1A, APOEB)
head(subset(lar.markers, cluster == 5))
VlnPlot(larva, "KCNIP3B", pt.size = 0)
VlnPlot(larva, "CALB2A", pt.size = 0)
VlnPlot(larva, "RLBP1A", pt.size = 0)

# Remove clusters
Idents(larva) <- "RNA_snn_res.0.8"
cells.remove = WhichCells(larva, idents= c(5, 28))
larva = SubsetData(larva ,cells = setdiff(colnames(larva), cells.remove))

# Set final cluster assignments
larva@meta.data$clusterID = droplevels(Idents(larva))
levels(larva@meta.data$clusterID) = 1:length(levels(larva@meta.data$clusterID))
Idents(larva) <- "clusterID"
```

Construct dendrogram based on hierarchical clustering and reorder clusters.
```{r}
# Build dendrogram
Idents(larva) <- "clusterID"
larva <- FindVariableFeatures(larva, selection.method = "vst", nfeatures = 500)
larva <- BuildClusterTree(larva)
PlotClusterTree(larva)
plot(larva@tools$BuildClusterTree)

# Reorder clusters according to dendrogram for dotplot plotting
tree_obj = larva@tools$BuildClusterTree
left_clusts = Seurat:::GetLeftDescendants(tree_obj, length(levels(larva@meta.data$clusterID))+1)
right_clusts = Seurat:::GetRightDescendants(tree_obj, length(levels(larva@meta.data$clusterID))+1)
clust_order = c(left_clusts, right_clusts)
larva@meta.data$dendro_order = factor(larva@meta.data$clusterID, levels = clust_order)
Idents(larva) <- "dendro_order"

# Save larval object
saveRDS(larva, "../Objects2020/larva_zFish_object.rds")
```

Identify all variable features
```{r}
lar.markers <- FindAllMarkers(larva, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
saveRDS(lar.markers, "../Objects2020/larva_ClusterMarkers")
```

Create Dot Plots for DE genes, globally expressed genes, and genes expressed in mature / immature clusters.
```{r}
# Extract top 3 DE genes from each cluster for plotting
DEGenes_vector <- vector()
for(i in levels(Idents(larva))){
  DEGenes_vector = union(DEGenes_vector, head(subset(lar.markers, cluster==i))[1:3,]$gene)
}
DEGenes_vector = tolower(DEGenes_vector[2:length(DEGenes_vector)])
larva <- LowerCase_genes(larva)
# Plot DE genes
DotPlot(larva, features = DEGenes_vector) + RotatedAxis()

# Plot canonical RGC markers
DotPlot(larva, features = tolower(c("ROBO2", "ISL2B", "RBPMS2B"))) + RotatedAxis()

# Plot immature and mature markers
DotPlot(larva, features = c("aldocb","bhlhe41","fam107b","bhlhe40","tmsb","alcamb","tubb5","fam60al")) + RotatedAxis()
```


Subset the larval dataset into mature and immature cells based on cluster identity.
```{r, message=FALSE, error=FALSE}
# Split larva into immature cells
immature_clusts = c("1","2","3","5","13","20")
immature_cells <- WhichCells(larva, idents =immature_clusts)

# Create new Seurat object for immature cells
immature <- CreateSeuratObject(Count.mat[,immature_cells])
# ClusterSeurat is a shortcut function that goes through the normal workflow
immature <- ClusterSeurat(immature)
# Import cluster ID from full larva object
immature@meta.data$orig_ID <- 0
immature@meta.data[immature_cells,]$orig_ID = as.numeric(larva@meta.data[immature_cells,]$clusterID)
levels(immature@meta.data$orig_ID) <- as.numeric(immature_clusts)
Idents(immature) <- "orig_ID"
```

Create Seurat object for mature cells
```{r}
# Subset larva object
mature_clusts = setdiff(levels(larva@meta.data$clusterID), immature_clusts)
mature_cells <- WhichCells(larva, idents = mature_clusts)

# Create separate object
mature <- CreateSeuratObject(Count.mat[,mature_cells])
mature <- ClusterSeurat(mature)
# Import cluster IDs from full larval object
mature@meta.data$orig_ID <- 0
mature@meta.data[mature_cells,]$orig_ID <- as.numeric(larva@meta.data[mature_cells,]$clusterID)
levels(mature@meta.data$orig_ID) <- as.numeric(mature_clusts)
Idents(mature) <- "orig_ID"
```

Plot tSNE reductions of immature and mature objects
```{r}
DimPlot(immature, reduction = "tsne", group.by = "orig_ID")
DimPlot(mature, reduction = "tsne", group.by = "orig_ID")
```

Calculate silhoutette scores for immature and mature clusters in tSNE space
```{r}
m.dist.matrix <- dist(x = Embeddings(mature, reduction = "tsne"))
m.clusters <- mature$orig_ID
m.sil <- silhouette(x = as.numeric(x = as.factor(x = m.clusters)), dist = m.dist.matrix)
print(c("Mature silhouette score: ", median(m.sil[,3])))

i.dist.matrix <- dist(x = Embeddings(immature, reduction = "tsne"))
i.clusters <- immature$orig_ID
i.sil <- silhouette(x = as.numeric(x = as.factor(x = i.clusters)), dist = i.dist.matrix)
print(c("Immature silhouette score: ", median(i.sil[,3])))
```

Save immature and mature objects
```{r}
saveRDS(mature, "../Objects2020/mature_zFish_object.rds")
saveRDS(immature, "../Objects2020/immature_zFish_object.rds")
```

